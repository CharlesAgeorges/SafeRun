<%= render "shared/navbar" %>
<%= render "shared/badges_modal" %>

<div class="container py-4 mb-5 pb-4" data-controller="tabs">
  <h1 class="profile-title">Mon Profil</h1>

  <!-- Navigation par onglets -->
  <div class="d-flex justify-content-center mb-4">
    <ul class="nav profile-tabs" id="profileTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="runs-tab" type="button" role="tab" aria-controls="runs" aria-selected="true" data-tabs-target="runs" data-action="click->tabs#toggle">
          <i class="fas fa-running me-2"></i>Runs
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="guardians-tab" type="button" role="tab" aria-controls="guardians" aria-selected="false" data-tabs-target="guardians" data-action="click->tabs#toggle">
          <i class="fas fa-shield-alt me-2"></i>Guardians
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="info-tab" type="button" role="tab" aria-controls="info" aria-selected="false" data-tabs-target="infos" data-action="click->tabs#toggle">
          <i class="fas fa-user me-2"></i>Infos
        </button>
      </li>
    </ul>
  </div>

  <!-- Contenu des onglets -->
  <div class="tab-content" id="profileTabsContent">

    <!-- Onglet Runs -->
    <div class="active" data-content="true" id="runs" role="tabpanel" aria-labelledby="runs-tab" data-tabs-target="runs" data-action="click->tabs#toggle">
      <div class="mb-4">
        <%= link_to new_run_path, class: "btn-new-run" do %>
          <i class="fas fa-plus"></i>NEW RUN
        <% end %>
      </div>

      <% if @runs.any? %>
        <div class="row">
          <% @runs.each do |run| %>
            <div class="col-12 mb-3">
              <div class="card">
                <% if run.status == "ended" && run.static_map_url %>
                  <%= image_tag run.static_map_url(width: 600, height: 200), class: "card-img-top" %>
                <% end %>
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-title mb-1"><%= run.start_point %></h6>
                      <small class="text-muted"><%= run.created_at.strftime("%d/%m/%Y") %></small>
                    </div>
                    <% status_class = case run.status
                      when "planned" then "police"
                      when "ended" then "green"
                      when "running" then "blue"
                      when "paused" then "orange"
                    end %>
                    <span class="fs-6 fw-normal <%= status_class %>"><%= run.status.capitalize %></span>
                  </div>
                  <div class="d-flex gap-3 mt-2">
                    <span><i class="fas fa-route me-1"></i><%= number_with_precision(run.distance, precision: 2) %> km</span>
                    <% if run.status == "ended" && run.real_duration_formatted %>
                      <span><i class="fas fa-clock me-1"></i><%= run.real_duration_formatted %></span>
                    <% else %>
                      <span><i class="fas fa-clock me-1"></i><%= run.duration %> min</span>
                    <% end %>
                  </div>
                </div>
                <div class="card-footer bg-transparent">
                  <% if run.status == "planned" %>
                    <%= link_to run_path(run), class: "btn-profile-runs me-2" do %>
                    <i class="fa-solid fa-eye"></i>
                    <% end %>
                    <%= link_to edit_run_path(run), class: "btn-profile-runs me-2" do %>
                    <i class="fas fa-edit"></i>
                    <% end %>
                    <%= link_to run_path(run), data: { turbo_method: :delete, turbo_confirm: "Supprimer cette run ?" }, class: "btn-profile-runs" do %>
                      <i class="fas fa-trash"></i>
                    <% end %>
                    <% elsif  run.status == "paused" || run.status == "running" %>
                    <%= link_to run_path(run), class: "btn-profile-runs" do %>
                      <i class="fas fa-eye me-1"></i>
                    <% end %>
                  <% end %>
                  <% if run.status.in?(%w[ended]) %>
                    <%= link_to make_public_run_path(run), data: { turbo_method: :patch }, class: "btn-profile-runs me-2" do %>
                      <i class="fa-solid fa-shield-heart"></i>
                    <% end %>
                    <%= link_to run_path(run), data: { turbo_method: :delete, turbo_confirm: "Supprimer cette run ?" }, class: "btn-profile-runs" do %>
                      <i class="fas fa-trash"></i>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>Vous n'avez pas encore de runs. Commencez votre première run !
        </div>
      <% end %>
    </div>

    <!-- Onglet Guardians -->
    <div class="d-none" data-content="true" id="guardians" role="tabpanel" aria-labelledby="guardians-tab" data-tabs-target="guardians" data-action="click->tabs#toggle">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Mes Guardians Angels</h4>
        <%= link_to new_guardian_path, class: "btn" do %>
          <i class="fas fa-plus me-2"></i>Ajouter un guardian
        <% end %>
      </div>

      <% if @guardians.any? %>
        <div class="row">
          <% @guardians.each do |guardian| %>
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-user-shield me-2 police"></i><%= guardian.name %>
                  </h5>
                  <p class="card-text">
                    <i class="fas fa-phone me-2 police"></i><%= guardian.phone_number %>
                  </p>
                </div>
                <div class="card-footer bg-transparent d-inline-flex">
                  <%= link_to edit_guardian_path(guardian), class: "btn btn-sm px-3 me-2" do %>
                    <i class="fas fa-edit"></i>
                  <% end %>
                  <%= link_to guardian_path(guardian), data: { turbo_method: :delete, turbo_confirm: "Supprimer ce guardian ?" }, class: "btn btn-sm px-3" do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>Vous n'avez pas encore de guardians. Ajoutez des contacts d'urgence pour plus de sécurité !
        </div>
      <% end %>
    </div>

    <!-- Onglet Infos -->
    <div class="d-none" data-content="true" id="info" role="tabpanel" aria-labelledby="info-tab" data-tabs-target="infos" data-action="click->tabs#toggle">
      <h4 class="mb-3">Informations personnelles</h4>

      <div class="card">
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-sm-4 text-muted">
              <i class="fas fa-user me-2"></i>Nom
            </div>
            <div class="col-sm-8">
              <%= @user.name || "Non renseigne" %>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-sm-4 text-muted">
              <i class="fas fa-envelope me-2"></i>Email
            </div>
            <div class="col-sm-8">
              <%= @user.email %>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-sm-4 text-muted">
              <i class="fas fa-phone me-2"></i>Telephone
            </div>
            <div class="col-sm-8">
              <%= @user.phone_number || "Non renseigne" %>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-sm-4 text-muted">
              <i class="fas fa-calendar me-2"></i>Membre depuis
            </div>
            <div class="col-sm-8">
              <%= @user.created_at.strftime("%d/%m/%Y") %>
            </div>
          </div>

          <hr>

          <div class="row">
            <div class="col-sm-4 text-muted">
              <i class="fas fa-chart-bar me-2"></i>Statistiques
            </div>
            <div class="col-sm-8">
              <span class=" me-2"><%= @runs.count %> runs</span>
              <span class=" me-2"><%= @badges.count %> badges</span>
              <span class=""><%= @guardians.count %> guardians</span>
            </div>
          </div>
        </div>

        <div class="card-footer bg-transparent">
          <%= link_to edit_user_registration_path, class: "btn" do %>
            <i class="fas fa-edit me-2"></i>Modifier mes informations
          <% end %>
        </div>
      </div>
    </div>

  </div>
</div>
